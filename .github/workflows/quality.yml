name: Code Quality CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 24
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '24'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Spotless Check
      run: ./gradlew spotlessCheck

    - name: Checkstyle
      run: ./gradlew checkstyleMain checkstyleTest

    - name: PMD and SpotBugs
      run: ./gradlew pmdMain pmdTest spotbugsMain spotbugsTest

    - name: Run Tests with Coverage
      run: ./gradlew test jacocoTestReport

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-test-reports
        path: |
          build/reports/tests/
          build/reports/jacoco/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 24
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '24'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # OWASP Dependency-Check Action
    - name: OWASP Dependency Check
      uses: jeremylong/DependencyCheck@v6
      with:
        project: 'github-actions-demo'
        scan: './'
        format: 'HTML'
        out: 'build/reports/dependency-check'
        args: >
          --failOnCVSS 7
          --suppression config/dependency-check/suppressions.xml

    - name: Upload OWASP report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: owasp-security-report
        path: build/reports/dependency-check/
        retention-days: 30

    # Snyk for Open Source Scanning
    - name: Snyk Scan
      uses: snyk/actions/gradle@master
      with:
        command: test
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    # Check for secrets
    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: .
        base: HEAD~1
        head: HEAD

  dependency-updates:
    name: Dependency Updates Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 24
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '24'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # Gradle Dependency Updates
    - name: Check for Dependency Updates
      run: ./gradlew dependencyUpdates

    - name: Upload dependency updates report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-updates-report
        path: build/reports/dependencyUpdates/
        retention-days: 30 